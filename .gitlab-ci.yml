# F7Lans GitLab CI/CD Pipeline
# Builds Windows client and containerized server

stages:
  - build
  - package
  - release
  - deploy

variables:
  DOCKER_IMAGE: f7lans-server
  DOCKER_REGISTRY: $CI_REGISTRY
  NODE_VERSION: "20"

# Cache node_modules between jobs
.node_cache: &node_cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - electron-client/node_modules/

# ============================================
# Windows Client Builds (native Windows runner)
# ============================================

# Remote Client - connects to external server (no embedded server)
build:windows-client-remote:
  stage: build
  tags:
    - windows
  cache:
    key: windows-${CI_COMMIT_REF_SLUG}
    paths:
      - electron-client/node_modules/
  before_script:
    - node --version
    - npm --version
  script:
    - cd electron-client
    - npm ci
    - npm run build:win
  artifacts:
    name: "f7lans-windows-remote-client-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/*.exe
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "web"

# Standalone Client - includes embedded server (all-in-one)
build:windows-client-standalone:
  stage: build
  tags:
    - windows
  cache:
    key: windows-standalone-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - electron-client/node_modules/
  before_script:
    - node --version
    - npm --version
  script:
    - npm ci
    - cd electron-client
    - npm ci
    - npm run copy-server
    - npm run build:win:unified
  artifacts:
    name: "f7lans-windows-standalone-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/unified/*.exe
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "web"

# ============================================
# Docker Container Build (Server) - Using Buildah
# Buildah builds OCI containers without Docker daemon
# ============================================
build:docker-server:
  stage: build
  tags:
    - debian
  variables:
    STORAGE_DRIVER: vfs
  before_script:
    - which buildah || (apt-get update && apt-get install -y buildah)
    - buildah --version
  script:
    # Build server image (using vfs storage driver and chroot isolation - no special permissions required)
    - buildah --storage-driver=vfs bud --isolation=chroot -t f7lans-server:${CI_COMMIT_SHORT_SHA} -f docker/Dockerfile.server .
    - buildah --storage-driver=vfs tag f7lans-server:${CI_COMMIT_SHORT_SHA} f7lans-server:latest
    # Push to registry if configured
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ]; then
        buildah --storage-driver=vfs login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
        buildah --storage-driver=vfs tag f7lans-server:${CI_COMMIT_SHORT_SHA} ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
        buildah --storage-driver=vfs tag f7lans-server:latest ${CI_REGISTRY_IMAGE}:latest
        buildah --storage-driver=vfs push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
        buildah --storage-driver=vfs push ${CI_REGISTRY_IMAGE}:latest
      fi
    # Save image as portable tarball
    - buildah --storage-driver=vfs push f7lans-server:${CI_COMMIT_SHORT_SHA} oci-archive:f7lans-server-${CI_COMMIT_SHORT_SHA}.tar
    - gzip f7lans-server-${CI_COMMIT_SHORT_SHA}.tar
  artifacts:
    name: "f7lans-server-docker-${CI_COMMIT_SHORT_SHA}"
    paths:
      - f7lans-server-*.tar.gz
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "web"

# Build web client container using Buildah
build:docker-webclient:
  stage: build
  tags:
    - debian
  variables:
    STORAGE_DRIVER: vfs
  before_script:
    - which buildah || (apt-get update && apt-get install -y buildah)
    - buildah --version
  script:
    - buildah --storage-driver=vfs bud --isolation=chroot -t f7lans-webclient:${CI_COMMIT_SHORT_SHA} -f docker/Dockerfile.webclient .
    - buildah --storage-driver=vfs tag f7lans-webclient:${CI_COMMIT_SHORT_SHA} f7lans-webclient:latest
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ]; then
        buildah --storage-driver=vfs login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
        buildah --storage-driver=vfs tag f7lans-webclient:${CI_COMMIT_SHORT_SHA} ${CI_REGISTRY_IMAGE}/webclient:${CI_COMMIT_SHORT_SHA}
        buildah --storage-driver=vfs tag f7lans-webclient:latest ${CI_REGISTRY_IMAGE}/webclient:latest
        buildah --storage-driver=vfs push ${CI_REGISTRY_IMAGE}/webclient:${CI_COMMIT_SHORT_SHA}
        buildah --storage-driver=vfs push ${CI_REGISTRY_IMAGE}/webclient:latest
      fi
    - buildah --storage-driver=vfs push f7lans-webclient:${CI_COMMIT_SHORT_SHA} oci-archive:f7lans-webclient-${CI_COMMIT_SHORT_SHA}.tar
    - gzip f7lans-webclient-${CI_COMMIT_SHORT_SHA}.tar
  artifacts:
    name: "f7lans-webclient-docker-${CI_COMMIT_SHORT_SHA}"
    paths:
      - f7lans-webclient-*.tar.gz
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ============================================
# Linux Client Builds
# ============================================

# Remote Client - connects to external server
build:linux-client-remote:
  stage: build
  image: electronuserland/builder:18
  tags:
    - debian
  <<: *node_cache
  script:
    - cd electron-client
    - npm ci
    - npm run build:linux
  artifacts:
    name: "f7lans-linux-remote-client-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/*.AppImage
      - electron-client/dist/*.deb
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# Standalone Client - includes embedded server
build:linux-client-standalone:
  stage: build
  image: electronuserland/builder:18
  tags:
    - debian
  <<: *node_cache
  script:
    - npm ci
    - cd electron-client
    - npm ci
    - npm run copy-server
    - npm run build:linux:unified
  artifacts:
    name: "f7lans-linux-standalone-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/unified/*.AppImage
      - electron-client/dist/unified/*.deb
      - electron-client/dist/unified/*.tar.gz
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ============================================
# Release Job (on tags)
# ============================================
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  tags:
    - debian
  needs:
    - job: build:windows-client-remote
      artifacts: true
    - job: build:windows-client-standalone
      artifacts: true
    - job: build:docker-server
      artifacts: true
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
    - ls -la electron-client/dist/ || true
  release:
    tag_name: $CI_COMMIT_TAG
    name: "F7Lans $CI_COMMIT_TAG"
    description: |
      ## F7Lans Release $CI_COMMIT_TAG

      ### Downloads
      - **Windows Remote Client** - Connects to an external F7Lans server
      - **Windows Standalone** - All-in-one with embedded server
      - **Docker Server** - Containerized server deployment
    assets:
      links:
        - name: "Windows Remote Client"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:windows-client-remote"
          link_type: package
        - name: "Windows Standalone (with Server)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:windows-client-standalone"
          link_type: package
        - name: "Docker Server Image"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:docker-server"
          link_type: package
  rules:
    - if: $CI_COMMIT_TAG

# ============================================
# Deploy Jobs (on tags only)
# Copies build artifacts to network share
# ============================================

deploy:linux:
  stage: deploy
  tags:
    - linux
  needs:
    - job: build:linux-client-remote
      artifacts: true
    - job: build:linux-client-standalone
      artifacts: true
    - job: build:docker-server
      artifacts: true
  script:
    - mkdir -p /mnt/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME
    - cp -r electron-client/dist/* /mnt/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/ || true
    - cp -r electron-client/dist/unified/* /mnt/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/ || true
    - cp -r f7lans-server-*.tar.gz /mnt/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/ || true
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

deploy:windows:
  stage: deploy
  tags:
    - windows
  needs:
    - job: build:windows-client-remote
      artifacts: true
    - job: build:windows-client-standalone
      artifacts: true
  script:
    - 'net use R: \\192.168.100.22\releases gitlab /user:root'
    - 'if not exist "R:\%CI_PROJECT_NAME%\%CI_COMMIT_REF_NAME%" mkdir "R:\%CI_PROJECT_NAME%\%CI_COMMIT_REF_NAME%"'
    - 'xcopy /E /I /Y electron-client\dist\*.exe "R:\%CI_PROJECT_NAME%\%CI_COMMIT_REF_NAME%\"'
    - 'xcopy /E /I /Y electron-client\dist\unified\*.exe "R:\%CI_PROJECT_NAME%\%CI_COMMIT_REF_NAME%\"'
    - 'net use R: /delete'
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"

deploy:macos:
  stage: deploy
  tags:
    - macos
  needs:
    - job: build:linux-client-remote
      artifacts: true
      optional: true
  script:
    - mkdir -p /tmp/releases
    - mount_smbfs //root:gitlab@192.168.100.22/releases /tmp/releases
    - mkdir -p /tmp/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME
    - cp -r electron-client/dist/* /tmp/releases/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME/ || true
    - umount /tmp/releases
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
