# F7Lans GitLab CI/CD Pipeline
# Builds Windows client and containerized server

stages:
  - build
  - package
  - release

variables:
  DOCKER_IMAGE: f7lans-server
  DOCKER_REGISTRY: $CI_REGISTRY
  NODE_VERSION: "20"

# Cache node_modules between jobs
.node_cache: &node_cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - electron-client/node_modules/

# ============================================
# Windows Client Builds (using Wine on Debian)
# ============================================

# Remote Client - connects to external server (no embedded server)
build:windows-client-remote:
  stage: build
  image: electronuserland/builder:wine
  tags:
    - debian
  <<: *node_cache
  before_script:
    - node --version
    - npm --version
  script:
    # Install electron-client dependencies only (no server needed)
    - cd electron-client
    - npm ci
    # Build Windows installer and portable (remote client only)
    - npm run build:win
  artifacts:
    name: "f7lans-windows-remote-client-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/*.exe
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "web"

# Standalone Client - includes embedded server (all-in-one)
build:windows-client-standalone:
  stage: build
  image: electronuserland/builder:wine
  tags:
    - debian
  <<: *node_cache
  before_script:
    - node --version
    - npm --version
  script:
    # Install root dependencies (needed for server bundling)
    - npm ci
    # Install electron-client dependencies
    - cd electron-client
    - npm ci
    # Copy server files into client for embedded mode
    - npm run copy-server
    # Build Windows installer with embedded server
    - npm run build:win:unified
  artifacts:
    name: "f7lans-windows-standalone-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/*.exe
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "web"

# ============================================
# Docker Container Build (Server) - Using Kaniko
# Kaniko builds containers without Docker daemon
# ============================================
build:docker-server:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.19.2-debug
    entrypoint: [""]
  tags:
    - debian
  script:
    # Create Kaniko config for registry auth
    - mkdir -p /kaniko/.docker
    - |
      if [ -n "$CI_REGISTRY" ]; then
        echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
      fi
    # Build and push server image
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/docker/Dockerfile.server" \
        --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}" \
        --destination "${CI_REGISTRY_IMAGE}:latest" \
        --tar-path "f7lans-server-${CI_COMMIT_SHORT_SHA}.tar" \
        --cache=true \
        --cache-ttl=168h
    - gzip f7lans-server-${CI_COMMIT_SHORT_SHA}.tar
  artifacts:
    name: "f7lans-server-docker-${CI_COMMIT_SHORT_SHA}"
    paths:
      - f7lans-server-*.tar.gz
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "web"

# Build web client container using Kaniko
build:docker-webclient:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.19.2-debug
    entrypoint: [""]
  tags:
    - debian
  script:
    - mkdir -p /kaniko/.docker
    - |
      if [ -n "$CI_REGISTRY" ]; then
        echo "{\"auths\":{\"${CI_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
      fi
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/docker/Dockerfile.webclient" \
        --destination "${CI_REGISTRY_IMAGE}/webclient:${CI_COMMIT_SHORT_SHA}" \
        --destination "${CI_REGISTRY_IMAGE}/webclient:latest" \
        --tar-path "f7lans-webclient-${CI_COMMIT_SHORT_SHA}.tar" \
        --cache=true \
        --cache-ttl=168h
    - gzip f7lans-webclient-${CI_COMMIT_SHORT_SHA}.tar
  artifacts:
    name: "f7lans-webclient-docker-${CI_COMMIT_SHORT_SHA}"
    paths:
      - f7lans-webclient-*.tar.gz
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ============================================
# Linux Client Builds
# ============================================

# Remote Client - connects to external server
build:linux-client-remote:
  stage: build
  image: electronuserland/builder:18
  tags:
    - debian
  <<: *node_cache
  script:
    - cd electron-client
    - npm ci
    - npm run build:linux
  artifacts:
    name: "f7lans-linux-remote-client-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/*.AppImage
      - electron-client/dist/*.deb
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# Standalone Client - includes embedded server
build:linux-client-standalone:
  stage: build
  image: electronuserland/builder:18
  tags:
    - debian
  <<: *node_cache
  script:
    - npm ci
    - cd electron-client
    - npm ci
    - npm run copy-server
    - npm run build:linux:unified
  artifacts:
    name: "f7lans-linux-standalone-${CI_COMMIT_SHORT_SHA}"
    paths:
      - electron-client/dist/*.AppImage
      - electron-client/dist/*.deb
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# ============================================
# Release Job (on tags)
# ============================================
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  tags:
    - debian
  needs:
    - job: build:windows-client-remote
      artifacts: true
    - job: build:windows-client-standalone
      artifacts: true
    - job: build:docker-server
      artifacts: true
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
    - ls -la electron-client/dist/ || true
  release:
    tag_name: $CI_COMMIT_TAG
    name: "F7Lans $CI_COMMIT_TAG"
    description: |
      ## F7Lans Release $CI_COMMIT_TAG

      ### Downloads
      - **Windows Remote Client** - Connects to an external F7Lans server
      - **Windows Standalone** - All-in-one with embedded server
      - **Docker Server** - Containerized server deployment
    assets:
      links:
        - name: "Windows Remote Client"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:windows-client-remote"
          link_type: package
        - name: "Windows Standalone (with Server)"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:windows-client-standalone"
          link_type: package
        - name: "Docker Server Image"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/download?job=build:docker-server"
          link_type: package
  rules:
    - if: $CI_COMMIT_TAG
